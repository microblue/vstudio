# VStudio — 剧本创作（Screenplay Creation）功能规格

## 1. 概述

在现有工作流「阶段 1：剧本编辑器」之前，新增**剧本创作**环节。用户输入故事大纲（自然语言），系统调用 LLM 一键生成专业格式的完整剧本，用户可选择不同大模型。

**定位：** 降低创作门槛——用户不需要懂编剧，只需描述故事想法，AI 即可输出可用于后续 pipeline 的剧本。

```
[新] 剧本创作（大纲 → 剧本）  →  [现有] 剧本编辑器（精修）  →  资产生成  →  ...
```

---

## 2. 用户流程

```
1. 用户点击「新建项目」或进入项目后选择「AI 生成剧本」
2. 填写故事大纲表单：
   - 故事梗概（必填，文本域）
   - 类型/风格（可选：科幻、悬疑、爱情、喜剧、恐怖等）
   - 目标时长（可选：1分钟/3分钟/5分钟/10分钟）
   - 语言（中文/英文/双语）
   - 补充要求（可选，自由文本：角色设定、世界观、特殊约束等）
3. 选择大模型：
   - Claude Sonnet 4（默认，快速）
   - Claude Opus 4（高质量）
   - GPT-4o
   - DeepSeek R1
   - 自定义（用户输入 API endpoint + key）
4. 点击「生成剧本」
5. 系统 streaming 输出剧本内容，实时显示
6. 生成完毕后，用户可：
   - 「采用」→ 剧本自动填入剧本编辑器，进入精修环节
   - 「重新生成」→ 调整参数后再次生成
   - 「换个模型试试」→ 切换模型重新生成，可对比不同版本
```

---

## 3. UI 设计

### 3.1 入口

- **新建项目时：** 创建项目后弹出选择「从大纲生成剧本」或「手动编写剧本」
- **项目内：** 剧本编辑器页面顶部增加「AI 生成剧本」按钮
- **路由：** `/project/:id/script/create`

### 3.2 页面布局

```
┌──────────────────────────────────────────────────────┐
│ ← 项目名  │  AI 剧本创作                    [历史版本] │
├────────────┼─────────────────────────────────────────┤
│            │  ┌─────────────────────────────────────┐│
│ 项目导航   │  │ 故事大纲 *                           ││
│            │  │ ┌─────────────────────────────────┐ ││
│ · 创作  ←  │  │ │ 一个少年发现自己生活在AI模拟的   │ ││
│ · 剧本     │  │ │ 世界中，他必须找到"源代码"才能   │ ││
│ · 资产     │  │ │ 回到现实...                      │ ││
│ · 分镜     │  │ └─────────────────────────────────┘ ││
│ · 生成     │  │                                      ││
│ · 音频     │  │ 类型: [科幻 ▼]  时长: [3分钟 ▼]     ││
│ · 合成     │  │ 语言: [中文 ▼]                       ││
│ · 导出     │  │                                      ││
│            │  │ 补充要求（可选）:                     ││
│            │  │ ┌─────────────────────────────────┐ ││
│            │  │ │ 主角16岁，名叫伏羲...            │ ││
│            │  │ └─────────────────────────────────┘ ││
│            │  │                                      ││
│            │  │ 模型: ○ Claude Sonnet  ● Claude Opus ││
│            │  │       ○ GPT-4o  ○ DeepSeek R1       ││
│            │  │       ○ 自定义...                    ││
│            │  │                                      ││
│            │  │        [生成剧本 ▶]                   ││
│            │  └─────────────────────────────────────┘│
│            │                                         │
│            │  ┌─────────────────────────────────────┐│
│            │  │ 生成结果（streaming 显示）            ││
│            │  │                                      ││
│            │  │ # 第一幕：觉醒                       ││
│            │  │ ## 场景1: 数据中枢                    ││
│            │  │ 黑暗的空间中，无数光点闪烁...         ││
│            │  │ ...                                   ││
│            │  │ █ (生成中...)                         ││
│            │  │                                      ││
│            │  │ [采用此剧本] [重新生成] [换模型对比]   ││
│            │  └─────────────────────────────────────┘│
└────────────┴─────────────────────────────────────────┘
```

### 3.3 版本对比视图

用户可用不同模型生成多个版本，左右分栏对比：

```
┌────────────────────────┬────────────────────────┐
│ 版本 A (Claude Opus)   │ 版本 B (GPT-4o)        │
│                        │                        │
│ # 第一幕...            │ # 第一幕...            │
│ ...                    │ ...                    │
│                        │                        │
│ [采用此版本]            │ [采用此版本]            │
└────────────────────────┴────────────────────────┘
```

---

## 4. 数据模型

### 4.1 新增表：`screenplay_drafts`

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | UUID | 主键 |
| `project_id` | UUID | 关联项目，FK → projects |
| `outline` | TEXT | 用户输入的故事大纲 |
| `genre` | VARCHAR(50) | 类型/风格 |
| `target_duration` | VARCHAR(20) | 目标时长 |
| `language` | VARCHAR(20) | 语言 |
| `extra_requirements` | TEXT | 补充要求 |
| `model` | VARCHAR(100) | 使用的模型标识 |
| `model_config` | JSONB | 模型配置（自定义 endpoint 等） |
| `generated_script` | TEXT | 生成的剧本内容（Markdown） |
| `version` | INTEGER | 版本号（同一项目可多次生成） |
| `status` | VARCHAR(20) | `generating` / `completed` / `failed` / `adopted` |
| `token_usage` | JSONB | token 用量统计 |
| `created_at` | TIMESTAMPTZ | 创建时间 |

**RLS 策略：** 用户只能访问自己项目下的 drafts。

---

## 5. API 设计

### 5.1 Edge Function: `screenplay-generate`

**请求：**
```
POST /functions/v1/screenplay-generate
Authorization: Bearer <user_jwt>
Content-Type: application/json

{
  "project_id": "uuid",
  "outline": "故事大纲文本...",
  "genre": "sci-fi",
  "target_duration": "3min",
  "language": "zh",
  "extra_requirements": "主角16岁...",
  "model": "claude-opus-4",
  "stream": true
}
```

**响应（streaming SSE）：**
```
data: {"type": "chunk", "content": "# 第一幕：觉醒\n\n"}
data: {"type": "chunk", "content": "## 场景1: ..."}
...
data: {"type": "done", "draft_id": "uuid", "token_usage": {"input": 800, "output": 3200}}
```

### 5.2 系统提示词设计

Edge Function 内置专业编剧 system prompt：

```
你是一位专业的影视编剧。根据用户提供的故事大纲，创作一份完整的短剧剧本。

要求：
1. 使用标准剧本格式（Markdown）：
   - # 幕 → ## 场景 → 场景描述 → 角色对话
   - 场景标题包含：场景编号、地点、时间（日/夜）
   - 对话格式：> **角色名**：台词内容
   - 动作/画面描述用普通段落
2. 根据目标时长控制剧本篇幅（1分钟 ≈ 3-5 个镜头 ≈ 150-250 字剧本）
3. 注重视觉叙事——每个场景要有清晰的画面描述，适合 AI 生成
4. 对话自然，推动情节
5. 包含镜头建议（景别、运镜）作为括号注释
```

### 5.3 模型路由

Edge Function 根据 `model` 参数路由到对应 API：

| 模型标识 | API | 备注 |
|---------|-----|------|
| `claude-sonnet-4` | Anthropic Messages API | 默认，快速 |
| `claude-opus-4` | Anthropic Messages API | 高质量 |
| `gpt-4o` | OpenAI Chat Completions API | 需配置 OpenAI key |
| `deepseek-r1` | DeepSeek API（OpenAI 兼容） | 性价比高 |
| `custom` | 用户自定义 endpoint | OpenAI 兼容格式 |

---

## 6. 前端组件

| 组件 | 说明 |
|------|------|
| `ScreenplayCreator` | 主容器，管理表单 + 生成流程 |
| `OutlineForm` | 大纲输入表单（梗概、类型、时长、语言、补充要求） |
| `ModelSelector` | 模型选择器（预设列表 + 自定义输入） |
| `StreamingPreview` | streaming 输出的 Markdown 实时渲染 |
| `DraftVersionList` | 历史版本列表 |
| `DraftCompare` | 双栏版本对比视图 |

---

## 7. 与现有模块的关系

- **剧本编辑器（2.2）：** 生成的剧本采用后，自动填入编辑器的 `script` 内容，项目状态设为 `SCRIPT_READY` 的前置状态
- **资产生成（2.3）：** 无直接关联，资产提取仍从编辑器中的最终剧本执行
- **系统设置（2.9）：** 新增 LLM 模型配置区域（多模型 API Key 管理）

---

## 8. 实现优先级

- **P0（MVP）：** 大纲表单 + Claude Sonnet/Opus 生成 + streaming 输出 + 采用到编辑器
- **P1：** 多模型支持（GPT-4o、DeepSeek）+ 版本管理
- **P2：** 版本对比视图 + 自定义模型 endpoint
